<div [ngClass]="isTablet ? 'max-w-4xl mx-auto px-4 py-8 mt-15 overflow-x-hidden' : 'container mx-auto px-4 py-8 mt-15'">
  <!-- Header -->
  <header [class]="getHeaderClass()">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Incident Management Dashboard</h1>
        <p class="text-gray-600" *ngIf="!isHSEUser()">Body Part Injuries Analysis</p>
        <p class="text-gray-600" *ngIf="isHSEUser() && !showTeamView">My Assigned Incidents</p>
        <p class="text-gray-600" *ngIf="isHSEUser() && showTeamView">Team Incidents Overview</p>
      </div>
      
      
      
     
    </div>
  </header>

  

  <!-- KPI Cards -->
  <div [class]="getKpiGridClass()" [ngClass]="{'max-w-full overflow-x-hidden': isTablet}">
    <ng-container *ngFor="let card of kpiCards">
      <div [class]="getCardClass()">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-gray-500 text-sm font-medium">{{ card.label }}</p>
            <h3 class="text-3xl font-bold text-gray-800 mt-2">{{ card.value }}</h3>
            <p [ngClass]="card.trendClass + ' text-sm mt-1'">
              <i class="fas" [ngClass]="card.trendIcon + ' mr-1'"></i>{{ card.trend }}
            </p>
          </div>
          <div [ngClass]="card.iconBg" class="p-3 rounded-full">
            <i class="fas" [ngClass]="card.icon + ' text-xl'" [ngStyle]="{ color: card.iconColor }"></i>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Charts -->
  <div *ngIf="!loading && !error && hasIncidentData" [class]="getChartsGridClass()" [ngClass]="{'max-w-full overflow-x-hidden': isTablet}">
    <div [class]="getChartCardClass()">
      <h2 [class]="getTitleClass()">Body Part Distribution</h2>
      <div [class]="getChartHeight()">
        <canvas id="bodyPartChart" style="height:100%; width:100%;"></canvas>
      </div>
    </div>
    <div [class]="getChartCardClass()">
      <h2 [class]="getTitleClass()">Incidents by Zone</h2>
      <div [class]="getChartHeight()">
        <canvas id="zoneChart" style="height:100%; width:100%;"></canvas>
      </div>
    </div>
    <div [class]="getChartCardClass()">
      <h2 [class]="getTitleClass()">Incidents by Shift</h2>
      <div [class]="getChartHeight()">
        <canvas id="shiftChart" style="height:100%; width:100%;"></canvas>
      </div>
    </div>
  </div>

  <!-- Trend Chart -->
  <div *ngIf="!loading && !error && hasIncidentData" [class]="getTrendCardClass()" [ngClass]="{'max-w-full overflow-x-hidden': isTablet}">
    <div class="flex justify-between items-center mb-4">
      <h2 [class]="getTitleClass()">Monthly Incident Trend</h2>
      
      <!-- Desktop buttons -->
      <div *ngIf="!isMobile" class="flex space-x-2">
        <button 
          (click)="switchTrendView('total')" 
          [ngClass]="trendViewMode === 'total' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'"
          class="px-3 py-1 rounded-md text-sm cursor-pointer">Total</button>
        <button 
          (click)="switchTrendView('bodyParts')" 
          [ngClass]="trendViewMode === 'bodyParts' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'"
          class="px-3 py-1 rounded-md text-sm cursor-pointer">Body Parts</button>
        <button 
          (click)="switchTrendView('zones')" 
          [ngClass]="trendViewMode === 'zones' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'"
          class="px-3 py-1 rounded-md text-sm cursor-pointer">Zones</button>
        <button 
          (click)="switchTrendView('shifts')" 
          [ngClass]="trendViewMode === 'shifts' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'"
          class="px-3 py-1 rounded-md text-sm cursor-pointer">Shifts</button>
      </div>
      
      <!-- Mobile dropdown -->
      <div *ngIf="isMobile">
        <select (change)="switchTrendView($any($event.target).value)" [value]="trendViewMode"
                class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="total">Total</option>
          <option value="bodyParts">Body Parts</option>
          <option value="zones">Zones</option>
          <option value="shifts">Shifts</option>
        </select>
      </div>
    </div>
    
    <!-- Time Range Controls -->
    <div class="flex justify-between items-center mb-4 bg-gray-50 rounded-lg p-3">
      <!-- Desktop period buttons -->
      <div *ngIf="!isMobile" class="flex flex-wrap gap-1">
        <span class="text-sm font-medium text-gray-700 mr-2 self-center">Period:</span>
        <button 
          (click)="changeTimeRange('last7Days')" 
          [ngClass]="currentTimeRange === 'last7Days' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'"
          class="px-2 py-1 rounded text-xs cursor-pointer transition-colors">7D</button>
        <button 
          (click)="changeTimeRange('last4Weeks')" 
          [ngClass]="currentTimeRange === 'last4Weeks' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'"
          class="px-2 py-1 rounded text-xs cursor-pointer transition-colors">4W</button>
        <button 
          (click)="changeTimeRange('last3Months')" 
          [ngClass]="currentTimeRange === 'last3Months' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'"
          class="px-2 py-1 rounded text-xs cursor-pointer transition-colors">3M</button>
        <button 
          (click)="changeTimeRange('last6Months')" 
          [ngClass]="currentTimeRange === 'last6Months' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'"
          class="px-2 py-1 rounded text-xs cursor-pointer transition-colors">6M</button>
        <button 
          (click)="changeTimeRange('last12Months')" 
          [ngClass]="currentTimeRange === 'last12Months' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'"
          class="px-2 py-1 rounded text-xs cursor-pointer transition-colors">1Y</button>
        <button 
          (click)="changeTimeRange('allTime')" 
          [ngClass]="currentTimeRange === 'allTime' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'"
          class="px-2 py-1 rounded text-xs cursor-pointer transition-colors">All</button>
      </div>
      
      <!-- Mobile period dropdown -->
      <div *ngIf="isMobile" class="w-full">
        <label class="block text-sm font-medium text-gray-700 mb-2">Period:</label>
        <select (change)="changeTimeRange($any($event.target).value)" [value]="currentTimeRange"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="last7Days">Last 7 Days</option>
          <option value="last4Weeks">Last 4 Weeks</option>
          <option value="last3Months">Last 3 Months</option>
          <option value="last6Months">Last 6 Months</option>
          <option value="last12Months">Last 12 Months</option>
          <option value="allTime">All Time</option>
        </select>
      </div>
      
      <!-- Swipe Navigation Controls -->
      <div class="flex items-center space-x-2" *ngIf="currentTimeRange !== 'allTime'">
        <button 
          (click)="navigatePrevious()"
          [disabled]="!canNavigatePrevious()"
          [ngClass]="canNavigatePrevious() ? 'text-blue-600 hover:text-blue-800 cursor-pointer' : 'text-gray-400 cursor-not-allowed'"
          class="p-2 rounded-full hover:bg-blue-50 transition-colors">
          <i class="fas fa-chevron-left"></i>
        </button>
        
        <div class="text-sm text-gray-600 min-w-[120px] text-center">
          {{ getTimeRangeTitle() }}
        </div>
        
        <button 
          (click)="navigateNext()"
          [disabled]="!canNavigateNext()"
          [ngClass]="canNavigateNext() ? 'text-blue-600 hover:text-blue-800 cursor-pointer' : 'text-gray-400 cursor-not-allowed'"
          class="p-2 rounded-full hover:bg-blue-50 transition-colors">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      
      <!-- All Time Display -->
      <div class="text-sm text-gray-600 min-w-[120px] text-center" *ngIf="currentTimeRange === 'allTime'">
        {{ getTimeRangeTitle() }}
      </div>
    </div>
    
    <div [class]="'relative ' + (isTablet ? 'h-[250px]' : 'h-[350px]')" 
         (touchstart)="onTouchStart($event)" 
         (touchend)="onTouchEnd($event)"
         style="touch-action: pan-y;">
      <canvas id="trendChart" style="height:100%; width:100%;"></canvas>
      
      <!-- Swipe indicator for mobile -->
      <div class="absolute bottom-2 right-2 text-xs text-gray-400 md:hidden" 
           *ngIf="currentTimeRange !== 'allTime'">
        <i class="fas fa-hand-paper"></i> Swipe to navigate
      </div>
    </div>
  </div>

  <!-- Status KPI Cards -->
  <div *ngIf="!loading && !error && hasIncidentData" [class]="getStatusGridClass()">
    <div [class]="getCardClass()">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 text-sm font-medium">Unopened Reports</p>
          <h3 class="text-3xl font-bold text-red-600 mt-2">{{ statusCounts.unopened }}</h3>
          <p class="text-red-500 text-sm mt-1">
            <i class="fas fa-exclamation-circle mr-1"></i>{{ getStatusPercentage('unopened') }}% of total
          </p>
        </div>
        <div class="bg-red-100 p-3 rounded-full">
          <i class="fas fa-envelope text-xl text-red-600"></i>
        </div>
      </div>
    </div>

    <div [class]="getCardClass()">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 text-sm font-medium">Open Reports</p>
          <h3 class="text-3xl font-bold text-yellow-600 mt-2">{{ statusCounts.opened }}</h3>
          <p class="text-yellow-500 text-sm mt-1">
            <i class="fas fa-clock mr-1"></i>{{ getStatusPercentage('opened') }}% of total
          </p>
        </div>
        <div class="bg-yellow-100 p-3 rounded-full">
          <i class="fas fa-folder-open text-xl text-yellow-600"></i>
        </div>
      </div>
    </div>

    <div [class]="getCardClass()">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-gray-500 text-sm font-medium">Closed Reports</p>
          <h3 class="text-3xl font-bold text-green-600 mt-2">{{ statusCounts.closed }}</h3>
          <p class="text-green-500 text-sm mt-1">
            <i class="fas fa-check-circle mr-1"></i>{{ getStatusPercentage('closed') }}% of total
          </p>
        </div>
        <div class="bg-green-100 p-3 rounded-full">
          <i class="fas fa-check-circle text-xl text-green-600"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="bg-white rounded-lg shadow-md p-8 text-center animated-card">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
    <p class="text-gray-600">Loading incident data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="bg-white rounded-lg shadow-md p-6 mb-6 animated-card">
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
        <span class="text-red-700">{{ error }}</span>
        <button (click)="loadIncidentReports()" class="ml-auto px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
          Retry
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && !hasIncidentData" class="bg-white rounded-lg shadow-md p-8 text-center animated-card">
    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-ambulance text-2xl text-gray-400"></i>
    </div>
    <h3 class="text-lg font-medium text-gray-800 mb-2">
      {{ isHSEUser() && !showTeamView ? 'No Assigned Incidents' : 'No Incident Reports' }}
    </h3>
    <p class="text-gray-600">
      {{ isHSEUser() && !showTeamView 
         ? 'You have no incidents assigned to you at this time.' 
         : 'No incident management reports have been submitted yet.' }}
    </p>
    <button *ngIf="isHSEUser() && !showTeamView" 
            (click)="toggleTeamView()" 
            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
      View Team Incidents
    </button>
  </div>

  <!-- Table -->
  <div *ngIf="!loading && !error && hasIncidentData" [class]="getTableCardClass()" [ngClass]="{'max-w-full overflow-x-hidden': isTablet}">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800">Incident Details</h2>
      <div class="flex items-center space-x-3">
        <!-- Team View Toggle Button for HSE Users -->
        <button *ngIf="isHSEUser()"
                (click)="toggleTeamView()"
                class="flex items-center px-3 py-2 rounded-md transition-colors text-sm"
                [ngClass]="showTeamView ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
          <i class="fas mr-2" [ngClass]="showTeamView ? 'fa-user' : 'fa-users'"></i>
          {{ showTeamView ? 'My Incidents' : 'Team View' }}
        </button>
        <button (click)="loadIncidentReports()" class="text-blue-600 hover:text-blue-800 flex items-center">
          <i class="fas fa-sync-alt mr-1"></i> Refresh
        </button>
      </div>
    </div>

    <!-- HSE User Info Banner -->
    <div *ngIf="isHSEUser()" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <div class="flex items-start">
        <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
        <div class="flex-1">
          <h4 class="text-sm font-medium text-blue-800 mb-1">HSE Agent Dashboard</h4>
          <p class="text-sm text-blue-700">
            <span *ngIf="!showTeamView">
              <strong>Personal View:</strong> Shows only incidents assigned to you. KPI indicators and statistics are calculated based on your assigned incidents.
            </span>
            <span *ngIf="showTeamView">
              <strong>Team View:</strong> Shows all team incidents for reference. KPI indicators still reflect your personal performance metrics.
            </span>
          </p>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select [(ngModel)]="filters.status" (change)="applyFilters()"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Status</option>
          <option value="Unopened">Unopened</option>
          <option value="Opened">Opened</option>
          <option value="Closed">Closed</option>
        </select>
      </div>

      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">Zone</label>
        <select [(ngModel)]="filters.zone" (change)="applyFilters()"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Zones</option>
          <option *ngFor="let zone of availableZones" [value]="zone">{{ zone }}</option>
        </select>
      </div>

      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
        <select [(ngModel)]="filters.severity" (change)="applyFilters()"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All Severities</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>

      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-gray-700 mb-1">HSE Agent</label>
        <select [(ngModel)]="filters.hseAgent" (change)="applyFilters()"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All HSE Agents</option>
          <option *ngFor="let agent of availableHSEAgents" [value]="agent">{{ agent }}</option>
        </select>
      </div>

      <div class="flex items-end">
        <button (click)="clearFilters()"
                class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">
          <i class="fas fa-times mr-1"></i> Clear
        </button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tracking #</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zone</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Injury Severity</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">HSE Assigned</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let report of filteredReports" class="hover:bg-gray-50">
            <td class="px-6 py-4 text-sm text-gray-500">
              {{ report.createdAt | date: 'dd/MM/yyyy HH:mm' }}
            </td>
            <td class="px-6 py-4 text-sm font-medium text-gray-900">
              {{ report.trackingNumber }}
            </td>
            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" [title]="report.title">
              {{ report.title }}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">{{ report.zone }}</td>
            <td class="px-6 py-4">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full items-center"
                    [ngClass]="getStatusClass(report.status)">
                <i [ngClass]="getStatusIcon(report.status)" class="mr-1"></i>
                {{ report.status }}
              </span>
            </td>
            <td class="px-6 py-4">
              <div class="flex flex-col space-y-1">
                <!-- Calculated severity from injuries -->
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full max-w-fit"
                      [ngClass]="getCalculatedSeverityClass(report.id)">
                  {{ getCalculatedSeverity(report.id) }}
                </span>
                <!-- Individual injury count -->
                <span class="text-xs text-gray-400">{{ getInjuryCount(report.id) }} injuries</span>
              </div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
              <div class="relative">
                <span *ngIf="report.assignedHSE" class="text-gray-900">{{ report.assignedHSE }}</span>
                <span *ngIf="!report.assignedHSE" class="text-gray-400 italic">Not assigned</span>
                
                <!-- Assignment dropdown for admin users -->
                <button *ngIf="!isHSEUser() && !showingAssignmentDropdown[report.id]" 
                        (click)="toggleAssignmentDropdown(report.id)"
                        class="ml-2 text-xs text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded-md transition-colors cursor-pointer">
                  <i class="fas fa-user-plus mr-1"></i>Assign
                </button>

                <!-- Assignment form -->
                <div *ngIf="showingAssignmentDropdown[report.id]" class="absolute top-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-10 min-w-[200px]">
                  <div class="mb-2">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Assign to HSE Agent:</label>
                    <p class="text-xs text-gray-500 mb-1">HSE Users available: {{ hseUsers.length }}</p>
                    <select [(ngModel)]="selectedHSEAgent[report.id]" 
                            class="w-full text-xs border border-gray-300 rounded-md px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                      <option value="">Select HSE Agent ({{ hseUsers.length }} available)</option>
                      <option *ngFor="let user of hseUsers" [value]="user.id">
                        {{ user.firstName }} {{ user.lastName }} ({{ user.email }})
                      </option>
                    </select>
                  </div>
                  <div class="flex space-x-2">
                    <button (click)="assignHSEAgent(report.id)"
                            class="flex-1 text-xs bg-blue-600 text-white px-2 py-1 rounded-md hover:bg-blue-700 transition-colors cursor-pointer">
                      Assign
                    </button>
                    <button (click)="cancelAssignment(report.id)"
                            class="flex-1 text-xs bg-gray-300 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-400 transition-colors cursor-pointer">
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 text-right text-sm font-medium">
              <a [routerLink]="['/reports', report.id]"
                 class="text-blue-600 hover:text-blue-900 flex items-center justify-end">
                <i class="fas fa-eye mr-1"></i>View
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
