<div class="h-16"></div>
<div class="container mx-auto px-4 py-8 max-w-6xl" *ngIf="report">
  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">{{ report.title }}</h1>

      <p class="text-gray-600">Detailed view of report and corrective actions</p>
    </div>
    <div class="flex space-x-3">
      <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center">
        <i class="fas fa-print mr-2"></i> Print
      </button>
      <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition flex items-center">
        <i class="fas fa-share-alt mr-2"></i> Share
      </button>
    </div>
  </div>

  <!-- Report Card -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
    <div class="p-6">
      <div class="flex justify-between items-start mb-6">
        <div>
          <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold mb-2">
            {{ report.type }}
          </span>
        </div>
        <div class="text-right">
          <span class="text-sm text-gray-500">Report ID</span>
          <p class="font-mono font-bold text-gray-800">{{ report.id }}</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div>
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1">Department</h3>
          <p class="text-gray-800 font-medium">{{ report.department }}</p>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1">Zone</h3>
          <p class="text-gray-800 font-medium">{{ report.zone }}</p>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1">Date & Time</h3>
          <p class="text-gray-800 font-medium">{{ report.situationDateTime | date: 'dd/MM/yyyy HH:mm' }}</p>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1">Reported By</h3>
          <div class="flex items-center space-x-2">
            <img [src]="reporter?.avatar || 'https://randomuser.me/api/portraits/lego/1.jpg'"
                 alt="Author avatar"
                 class="w-8 h-8 rounded-full border border-gray-300 object-cover">
            <p class="text-gray-800 font-medium">{{ reporter?.fullName }}</p>
          </div>
        </div>
      </div>

      <div class="mb-6">
        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Description</h3>
        <div class="bg-gray-50 p-4 rounded-lg">
          <p class="text-gray-800">{{ report.description }}</p>
        </div>
      </div>

      <div class="mb-6" *ngIf="report.attachments.length > 0">
        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Attachments</h3>
        <div class="flex space-x-4">
          <div class="relative group" *ngFor="let attachment of report.attachments">
            <img [src]="attachment" alt="Attachment" class="w-32 h-32 object-cover rounded-lg border border-gray-200 cursor-pointer" />
          </div>
        </div>
      </div>

      <!-- Injury Card Section -->
      <div *ngIf="report?.type === 'Incident-Management' && injuryCards?.length" class="space-y-6 mb-10">
        <div *ngFor="let card of injuryCards" class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-semibold text-red-600 mb-4">ü©∫ Injury Card</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">

            <!-- Left: Injury Info -->
            <div>
              <p class="mb-2 text-sm"><strong>üë§ Injured:</strong> {{ card.injuredName }}</p>
              <p class="mb-2 text-sm"><strong>üè¢ Department:</strong> {{ card.department }}</p>
              <p class="mb-2 text-sm"><strong>üó∫Ô∏è Zone:</strong> {{ card.zone }}</p>
              <p class="mb-4 text-sm"><strong>üöª Gender:</strong> {{ card.gender }}</p>

              <h4 class="font-semibold text-sm text-gray-700 mb-2">ü¶¥ Injuries:</h4>
              <ul class="list-disc list-inside text-sm space-y-1 mb-4">
                <li *ngFor="let injury of card.injuries">
                  <strong>{{ injury.bodyPart }}</strong> ‚Äì {{ injury.injuryType }} ({{ injury.severity }})
                </li>
              </ul>

              <h4 class="font-semibold text-sm text-gray-700 mb-2">üìù Description:</h4>
              <p class="text-sm text-gray-700">
                {{ isDescriptionExpanded ? card.description : (card.description | slice:0:120) + '...' }}
                <button class="text-blue-600 hover:underline text-xs ml-2" (click)="isDescriptionExpanded = !isDescriptionExpanded">
                  {{ isDescriptionExpanded ? 'See less' : 'See more' }}
                </button>
              </p>
            </div>

            <!-- Right: Body Map -->
            <div class="mt-[-40px] md:mt-[-90px]">
              <app-body-map [injuries]="card.injuries" mode="view"></app-body-map>
            </div>
          </div>
        </div>
      </div>



      <!-- Recommended Actions -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6" *ngIf="report.recommendations?.length">
        <div *ngFor="let r of report.recommendations" class="mb-4">
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">
            Recommended Actions By {{ getUserName(r.owner) }}
            <span class="px-4 py-1 text-xs font-semibold uppercase tracking-wide border rounded-full"
                  [ngClass]="{
                    'bg-green-100 text-green-800 border-green-300': r.status === 'Completed',
                    'bg-yellow-100 text-yellow-800 border-yellow-300': r.status === 'In Progress',
                    'bg-red-100 text-red-800 border-red-300': r.status === 'Not Started'
                  }">
              {{ r.status }}
            </span>
          </h3>
          <div class="bg-blue-50 p-4 rounded-lg">
            <p class="text-gray-800">{{ r.description }}</p>
          </div>
        </div>

        <!-- Global Status + Progress -->
        <div>
          <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Status</h3>
          <div class="flex items-center">
            <span class="px-4 py-1 text-sm font-semibold uppercase tracking-wide border rounded-full mr-3"
                  [ngClass]="getProgressBadgeClass(report)">
              {{ report.status }}
            </span>
            <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden relative">
              <div class="h-2.5 rounded-full transition-all duration-700 ease-in-out"
                   [ngClass]="getProgressBarColorClass(report)"
                   [style.width.%]="getReportProgress(report)">
              </div>
            </div>
            <span class="ml-3 text-sm font-medium text-gray-700">{{ getReportProgress(report) }}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Corrective Actions -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8" *ngIf="report?.actions?.length">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-bold text-gray-800 flex items-center">
        <i class="fas fa-tasks mr-3 text-blue-600"></i> Corrective Actions
      </h2>
      <p class="text-gray-600 mt-1">Track and manage all actions related to this incident</p>
    </div>

    <div class="divide-y divide-gray-200">
      <div class="p-6 action-card" *ngFor="let action of report.actions">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-800">{{ action.title }}</h3>
            <div class="flex items-center mt-1">
              <span class="px-4 py-1 text-sm font-semibold uppercase tracking-wide border rounded-full mr-3"
                    [ngClass]="{
                      'bg-green-100 text-green-800 border-green-300': action.status === 'Completed',
                      'bg-yellow-100 text-yellow-800 border-yellow-300': action.status === 'In Progress',
                      'bg-red-100 text-red-800 border-red-300': action.status === 'Not Started'
                    }">
                {{ action.status }}
              </span>
              <span class="text-sm text-gray-500">Due: {{ action.dueDate | date: 'dd/MM/yyyy' }} </span>
            </div>
          </div>
        </div>

        <p class="text-gray-700 mb-4">{{ action.description }}</p>

        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">
              Assigned to: <span class="font-semibold">{{ getUserName(action.assignedTo) }}</span>
            </span>
            <button class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
              <i class="fas fa-plus mr-1"></i> Add Sub-action
            </button>
          </div>

          <div class="mt-3 space-y-4" *ngIf="action.subActions?.length">
            <div class="subaction-item pl-4" *ngFor="let sub of action.subActions">
              <div class="subaction-dot"></div>
              <div class="bg-white p-3 rounded-lg border border-gray-200">
                <div class="flex justify-between items-start">
                  <div>
                    <h4 class="font-medium text-gray-800">{{ sub.title }}</h4>
                    <p class="text-sm text-gray-600 mt-1">{{ sub.description }}</p>
                  </div>
                  <span class="px-4 py-1 text-xs font-semibold uppercase tracking-wide border rounded-full"
                        [ngClass]="{
                          'bg-green-100 text-green-800 border-green-300': sub.status === 'Completed',
                          'bg-yellow-100 text-yellow-800 border-yellow-300': sub.status === 'In Progress',
                          'bg-red-100 text-red-800 border-red-300': sub.status === 'Not Started'
                        }">
                    {{ sub.status }}
                  </span>
                </div>
                <div class="flex justify-between items-center mt-2 text-sm">
                  <span class="text-gray-500">Due: {{ sub.dueDate | date: 'dd/MM/yyyy' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="p-6 bg-gray-50 rounded-b-xl">
      <button class="w-full py-3 px-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition flex items-center justify-center text-blue-600">
        <i class="fas fa-plus-circle mr-2"></i> Add New Corrective Action
      </button>
    </div>

  </div>


  <!-- Comments -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8" *ngIf="report?.comments?.length">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-bold text-gray-800 flex items-center">
        <i class="fas fa-comments mr-3 text-blue-600"></i> Comments & Updates
      </h2>
    </div>

    <div class="p-6 space-y-6">
      <div class="flex" *ngFor="let comment of report.comments">
        <div class="flex-shrink-0 mr-4">
          <img class="h-10 w-10 rounded-full border border-gray-300 object-cover"
               [src]="getUserAvatar(comment.author)"
               alt="{{ comment.author }}" />
        </div>
        <div class="flex-1">
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-1">
              <span class="font-medium text-gray-800">{{ getUserName(comment.author) }}</span>
              <span class="text-sm text-gray-500">{{ comment.timestamp | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <p class="text-gray-700">{{ comment.message }}</p>
          </div>
        </div>
      </div>

      <!-- Add Comment -->
      <div class="flex">
        <div class="flex-shrink-0 mr-4">
          <img class="h-10 w-10 rounded-full border border-gray-300 object-cover"
               [src]="getCurrentUserAvatar()"
               alt="Current user" />
        </div>
        <div class="flex-1">
          <form (ngSubmit)="submitComment()" #commentForm="ngForm">
            <textarea rows="3"
                      name="message"
                      [(ngModel)]="newComment.message"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Add a comment..."></textarea>
            <div class="flex justify-end mt-2">
              <button type="submit"
                      [disabled]="!commentForm.valid"
                      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                Post Comment
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
