<!DOCTYPE html>
<html>
<head>
    <title>Update Corrective Action Statuses</title>
</head>
<body>
    <h1>Update Corrective Action Statuses</h1>
    <button onclick="updateStatuses()">Update All Corrective Action Statuses</button>
    <div id="results"></div>

    <script>
        const API_BASE = `http://${window.location.hostname}:5225/api`;
        
        function log(message) {
            const div = document.getElementById('results');
            div.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        async function updateStatuses() {
            log('üîÑ Starting corrective action status update...');
            
            try {
                // First get a summary of current statuses
                const summaryResponse = await fetch(API_BASE + '/maintenance/corrective-action-status-summary', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (summaryResponse.ok) {
                    const summaryData = await summaryResponse.json();
                    log(`üìä Found ${summaryData.totalCorrectiveActions} corrective actions`);
                    log(`‚ùó Status mismatches: ${summaryData.statusMismatches}`);
                    
                    if (summaryData.statusMismatches > 0) {
                        log('üîß Found mismatches, showing details:');
                        summaryData.correctiveActions.forEach(ca => {
                            if (ca.statusMismatch) {
                                log(`  ‚Ä¢ CA${ca.id} "${ca.title}": Current="${ca.currentStatus}" ‚Üí Should be="${ca.calculatedStatus}"`);
                            }
                        });
                    }
                } else {
                    log('‚ö†Ô∏è Could not get status summary (endpoint may require admin access)');
                }
                
                // Now try to update statuses
                const updateResponse = await fetch(API_BASE + '/maintenance/update-corrective-action-statuses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`Update Response Status: ${updateResponse.status}`);
                
                if (updateResponse.ok) {
                    const updateData = await updateResponse.json();
                    log(`‚úÖ Update completed: ${updateData.updated}/${updateData.totalProcessed} records updated`);
                    log(`üìù Message: ${updateData.message}`);
                } else {
                    const error = await updateResponse.text();
                    log(`‚ùå Update failed: ${error}`);
                }
                
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }
    </script>
</body>
</html>